<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qiscus Multichannel Widget - SOLID Architecture Demo</title>
    <!-- 
    âš ï¸ DISCLAIMER / PENAFIAN:
    
    English:
    This is an UNOFFICIAL open-source project. Any consequences or issues arising 
    from the use of this project are NOT the responsibility of Qiscus. 
    As this is open-source software, you are free to modify it as extensively as you wish.
    
    Bahasa Indonesia:
    Project ini bersifat UNOFFICIAL artinya segala apapun akibat yang akan timbul 
    BUKAN tanggung jawab dari sisi Qiscus, dan karena sifatnya open source 
    boleh dimodifikasi semaksimal mungkin.
    -->
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="page-container">
        <!-- Header -->
        <div class="page-header">
            <h1>ğŸš€ Qiscus Multichannel Widget</h1>
            <p class="subtitle">SOLID Architecture Demo & Testing Environment</p>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer-card">
            <h3>âš ï¸ Disclaimer / Penafian</h3>
            <p><strong>English:</strong><br>
                This is an <strong>unofficial</strong> open-source project. Any consequences or issues arising from the
                use of this project are <strong>not the responsibility of Qiscus</strong>. As this is open-source
                software, you are free to modify it as extensively as you wish.</p>
            <p><strong>Bahasa Indonesia:</strong><br>
                Project ini bersifat <strong>unofficial</strong> artinya segala apapun akibat yang akan timbul
                <strong>bukan tanggung jawab dari sisi Qiscus</strong>, dan karena sifatnya open source boleh
                dimodifikasi semaksimal mungkin.</p>
        </div>

        <!-- Architecture Info -->
        <div class="info-card">
            <h3>âœ¨ Architecture Improvements</h3>
            <ul>
                <li><strong>Single Responsibility:</strong> Each service handles one concern</li>
                <li><strong>Open/Closed:</strong> Easy to extend without modifying existing code</li>
                <li><strong>Dependency Inversion:</strong> Services are injected, not hardcoded</li>
                <li><strong>Better Testability:</strong> Services can be mocked and tested independently</li>
                <li><strong>Maintainability:</strong> Clear separation makes debugging easier</li>
            </ul>
        </div>

        <!-- Demo Controls -->
        <div class="demo-section">
            <h2>ğŸ® Demo Controls</h2>
            <div class="button-grid">
                <button class="btn" onclick="initWidget()">
                    <span>ğŸ”§</span> Initialize Widget
                </button>
                <button class="btn" onclick="startChat()">
                    <span>ğŸ’¬</span> Start Chat
                </button>
                <button class="btn" onclick="sendTestMessage()">
                    <span>ğŸ“¤</span> Send Test Message
                </button>
                <button class="btn btn-secondary" onclick="showState()">
                    <span>ğŸ“Š</span> Show State
                </button>
                <button class="btn btn-danger" onclick="clearSession()">
                    <span>ğŸ—‘ï¸</span> Clear Session
                </button>
            </div>
        </div>

        <!-- Media Upload -->
        <div class="demo-section">
            <h2>ğŸ“ Media Upload</h2>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept="image/*,video/*,.pdf,.doc,.docx">
            </div>
            <button class="btn" onclick="uploadMedia()">
                <span>ğŸ“¤</span> Upload & Send Media
            </button>
            <div id="uploadProgress" class="upload-progress" style="display: none;">
                <p>Uploading: <span id="uploadFileName"></span></p>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <p class="progress-percent"><span id="progressPercent">0</span>%</p>
            </div>
        </div>

        <!-- Event Log -->
        <div class="demo-section">
            <h2>ğŸ“‹ Event Log</h2>
            <div id="log" class="event-log"></div>
        </div>
    </div>

    <!-- Load all service modules -->
    <script src="services/EventEmitter.js"></script>
    <script src="services/LoggerService.js"></script>
    <script src="services/StorageService.js"></script>
    <script src="services/SDKService.js"></script>
    <script src="services/APIService.js"></script>
    <script src="services/StateManager.js"></script>
    <script src="services/UIService.js"></script>
    <script src="services/ChatService.js"></script>
    <script src="qiscus-widget.js"></script>

    <script>
        let widget;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : 'log-info';

            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${timestamp}]</span><span class="${logClass}">${message}</span>`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function initWidget() {
            try {
                widget = new QiscusMultichannelWidget({
                    appId: 'ramo-29lun8b1ulepsaio', // Replace with your actual App ID
                    channelId: '127590', // Optional
                    primaryColor: '#0ea371',
                    debugMode: true,
                    onReady: (w) => {
                        log('âœ… Widget ready!', 'success');
                    },
                    onLoginSuccess: (user) => {
                        log(`âœ… Login success: ${user.username}`, 'success');
                    },
                    onLoginError: (error) => {
                        log(`âŒ Login error: ${error.message}`, 'error');
                    },
                    onMessageReceived: (message) => {
                        log(`ğŸ“¨ Message received: ${message.message}`);
                    },
                    onMessageSent: (message) => {
                        log(`ğŸ“¤ Message sent: ${message.message}`, 'success');
                    },
                    onRoomChanged: (room) => {
                        log(`ğŸ  Room changed: ${room}`);
                    },
                    onTyping: (data) => {
                        log(`âŒ¨ï¸ Typing: ${data.typing}`);
                    }
                });

                // Set user information
                widget.setUser({
                    userId: 'user-' + Date.now(),
                    displayName: 'Demo User',
                    avatarUrl: 'https://ui-avatars.com/api/?name=Demo+User',
                    userProperties: {
                        department: 'Support'
                    }
                });

                // Setup media event listeners
                setupMediaEvents();

                log('âœ… Widget initialized successfully', 'success');
            } catch (error) {
                log(`âŒ Initialization error: ${error.message}`, 'error');
            }
        }

        function startChat() {
            if (!widget) {
                log('âŒ Please initialize widget first', 'error');
                return;
            }

            widget.initiateChat()
                .then(() => {
                    log('âœ… Chat initiated successfully', 'success');
                })
                .catch(error => {
                    log(`âŒ Chat initiation error: ${error.message}`, 'error');
                });
        }

        function sendTestMessage() {
            if (!widget) {
                log('âŒ Please initialize widget first', 'error');
                return;
            }

            widget.sendMessage('Hello from SOLID refactored widget! ğŸ‘‹')
                .then(() => {
                    log('âœ… Test message sent', 'success');
                })
                .catch(error => {
                    log(`âŒ Send message error: ${error.message}`, 'error');
                });
        }

        function clearSession() {
            if (!widget) {
                log('âŒ Please initialize widget first', 'error');
                return;
            }

            widget.clearUser();
            log('ğŸ—‘ï¸ Session cleared', 'success');
        }

        function showState() {
            if (!widget) {
                log('âŒ Please initialize widget first', 'error');
                return;
            }

            const state = widget.getState();
            console.log('Current State:', state);
            log('ğŸ“Š State logged to console (F12)', 'success');
        }

        // Media upload function
        async function uploadMedia() {
            if (!widget) {
                log('âŒ Please initialize widget first', 'error');
                return;
            }

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                log('âŒ Please select a file first', 'error');
                return;
            }

            const roomId = widget.stateManager.get('roomId');
            if (!roomId) {
                log('âŒ No active room. Please start chat first.', 'error');
                return;
            }

            try {
                log(`ğŸ“¤ Preparing to upload: ${file.name}`, 'info');

                // Prepare and validate file
                const mediaOrDocs = widget.chatService.prepareFileForUpload(file);

                // Upload and send
                await widget.chatService.uploadAndSendMedia(mediaOrDocs, roomId);

                log(`âœ… Media sent successfully: ${file.name}`, 'success');
                fileInput.value = ''; // Clear input

            } catch (error) {
                log(`âŒ Upload error: ${error.message}`, 'error');
            }
        }

        // Setup media event listeners
        function setupMediaEvents() {
            if (!widget || !widget.eventEmitter) return;

            // Listen for upload progress
            widget.eventEmitter.on('media:progress', (data) => {
                const progressDiv = document.getElementById('uploadProgress');
                const fileNameSpan = document.getElementById('uploadFileName');
                const progressFill = document.getElementById('progressFill');
                const progressPercent = document.getElementById('progressPercent');

                progressDiv.style.display = 'block';
                fileNameSpan.textContent = data.filename;
                progressFill.style.width = data.percent + '%';
                progressPercent.textContent = data.percent;

                log(`â³ Upload progress: ${data.percent}%`, 'info');
            });

            // Listen for upload complete
            widget.eventEmitter.on('media:uploaded', (data) => {
                const progressDiv = document.getElementById('uploadProgress');
                progressDiv.style.display = 'none';
                log('âœ… Media uploaded successfully!', 'success');
            });

            // Listen for upload error
            widget.eventEmitter.on('media:error', (data) => {
                const progressDiv = document.getElementById('uploadProgress');
                progressDiv.style.display = 'none';
                log(`âŒ Media upload failed: ${data.error.message}`, 'error');
            });
        }

        // Auto-initialize on page load
        window.addEventListener('load', () => {
            log('ğŸ‰ Page loaded. Click "Initialize Widget" to start.');
        });
    </script>
</body>

</html>